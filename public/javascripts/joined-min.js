(function(f){var b,m;m={check:function(){var e=!0;this.find(b.errorElement+"."+b.errorClass).remove();this.find(":input."+b.inputErrorClass).removeClass(b.inputErrorClass);this.find(":input.required").each(function(){var r=f(this),m=f.trim(r.val()),s=r.siblings("label").text().replace(b.removeLabelChar,""),q="";if(m==="")q=hasLabelPlaceholder?q=b.errorText.replace("{label}",s):q=b.errorText,e=!1;else if(r.hasClass("email")&&!/^([_a-z0-9-]+)(\.[_a-z0-9-]+)*@([a-z0-9-]+)(\.[a-z0-9-]+)*(\.[a-z]{2,4})$/.test(m))q=
hasLabelPlaceholder?q=b.emailErrorText.replace("{label}",s):q=b.emailErrorText,e=!1;q!==""&&r.parent().addClass(b.errorClass)});return e},reset:function(){return this.find(":input.required").each(function(){f(this).parent().removeClass(b.errorClass)})}};f.fn.isValid=function(b){m[b]||(b="check");return m[b].apply(this,Array.prototype.slice.call(arguments,1))};f.fn.isValid.init=function(e){b=f.extend({},f.fn.isValid.defaults,e);hasLabelPlaceholder=b.errorText.indexOf("{label}")>-1};f.fn.isValid.defaults=
{errorClass:"error",errorText:"{label} is a required field.",emailErrorText:"Please enter a valid {label}",errorElement:"strong",removeLabelChar:"*"}})(jQuery);
var ME=function(f){function b(a){f.extend(this,a);this.prototype=b.prototype}function m(a,c){this.name=a;if(c)this.clicked=c,t.push(a)}function e(a,c,d){m.apply(this,[a,d]);this.options=c||[]}function r(){var a,c,d;if(!p){a=0;for(c=o.length;a<c;a++)(d=l[o[a]])&&(p+=d.getButton())}return p}function u(a){var c=f('<div class="toolbar"></div>'),d=this;this.textArea=a.textArea;this.htmlDiv=a.htmlDiv;this.editor=a;this.div=c;c.html(r());c.mouseup(function(c){c=c.target;if(!/(select|option)/i.test(c.nodeName)){if(/span/i.test(c.nodeName))c=
c.parentNode;if(c.disabled)return a.is("wysiwyg")?a.htmlDiv.focus():a.textArea.focus(),!1;var k=c.className;k=k.split(" ")[0];d.runAction(k,c);a.checkState()}}).change(function(a){a=a.target;d.runAction(a.className,a);return!1}).click(function(){return!1});a.container.prepend(c)}function s(a,c){var d=this,h=0;this.loadedModes={};this.setDataType(a.attr("class"));this.settings=c;if(this.dataType)this.textArea=a.bind("mouseup keyup",function(){d.checkState();clearTimeout(h);h=setTimeout(function(){d.currentMode.updatePreview()},
1E3)}).keydown(function(a){return d.currentMode.pressed(a.keyCode)}).keyup(function(a){return d.currentMode.released(a.keyCode)}),this.htmlDiv=f('<div class="preview"></div>').bind("mouseup keyup",function(){d.is("wysiwyg")&&d.checkState()}).keydown(function(a){return d.currentMode.pressed(a.keyCode)}),this.container=a.wrap('<div class="markupEditor"></div>').parent().append(d.htmlDiv),a.wrap('<div class="textarea">'),this.toolbar=new u(this)}function q(a,c){var d;d={};f.extend(d,g,c);d=new s(a,d);
d.currentMode=d.getDataMode();if(a.hasClass("wysiwyg"))d.currentMode.activate(),d.currentMode=d.getMode("wysiwyg");d.currentMode.activate();d.toolbar.setActive({changeMode:d.currentMode.id});return d}var g={},j={},l={},p="",o=["bold","italic","alignLeft","alignCenter","alignRight","unorderedList","orderedList","link","insertImage","save","changeMode","formatBlock"],t=[];b.prototype={load:function(a){this.editor=a;this.htmlDiv=a.htmlDiv;this.textArea=a.textArea;console.log("loaded Mode "+this.name)},
getStates:f.noop,pressed:function(a){if(a===16)this.holdShift=!0},released:function(a){if(a===16)this.holdShift=!1},activate:function(){this.htmlDiv.is(":empty")?this.updatePreview():this.updateTextArea();this.editor.toolbar.loadModeToolbar();this.afterActivation()},updatePreview:function(){console.log("updating preview in Mode "+this.name);this.htmlDiv.html(this.toHTML()||"<p>&nbsp;</p>")},updateTextArea:function(){console.log("updating TA in Mode "+this.name);this.textArea.val(this.toText())},afterActivation:function(){this.textArea.parent().show().find(":first-child").focus()[0].setSelectionRange(0,
0);this.htmlDiv.attr("contentEditable",!1)},buildStateObject:function(a,c){for(var d,h=a.length,k={};h--;)switch(d=a[h],d.tag?d.tag:d.nodeName.toLowerCase()){case "a":c.a=d;k.link=!0;break;case "img":c.img=d;k.insertImage=!0;break;case "i":k.italic=!0;break;case "b":k.bold=!0;break;case "ol":k.orderedList=!0;k.unorderedList=!1;k.formatBlock="disable";k.alignLeft="disable";k.alignRight="disable";k.alignCenter="disable";c.list=d;break;case "ul":k.orderedList=!1;k.unorderedList=!0;k.formatBlock="disable";
k.alignLeft="disable";k.alignRight="disable";k.alignCenter="disable";c.list=d;break;case "li":break;default:k.formatBlock=d.tag?d.tag:d.nodeName.toLowerCase(),c.block=d}return k},getSelection:function(a){var c=this.textArea,d=c.val(),h;c.focus();this.scrollPosition=c.scrollTop;this.selectionStart=c[0].selectionStart;this.selectionEnd=c[0].selectionEnd;d[this.selectionEnd-1]==="\n"&&(this.selectionEnd-=1);if(a){c=Math.max(d.lastIndexOf(a,this.selectionStart),d.lastIndexOf("\n",this.selectionStart));
this.selectionStart=c!==-1?c+1:0;c=d.indexOf("\n",this.selectionEnd);h=c===-1?d.slice(this.selectionStart):d.slice(this.selectionStart,c);c=0;do c=h.indexOf(a,c+1);while(c!==-1&&this.selectionEnd>this.selectionStart+c);if(c===-1)c=h.length;this.selectionEnd=this.selectionStart+c}return this.selection=d.slice(this.selectionStart,this.selectionEnd)},replaceSelection:function(a,c){var d=this.textArea,h=this.selectionStart,k=this.selectionStart+a.length;d.val(d.val().slice(0,this.selectionStart)+a+d.val().slice(this.selectionEnd,
d.val().length));c===!0?k=h:c===!1&&(h=k);d[0].setSelectionRange(h,k);d.focus()},extendRightSelection:function(a){var c;a=RegExp(a.source,"g");a.lastIndex=this.selectionEnd;if((c=a.exec(this.textArea.val()))&&a.lastIndex==this.selectionEnd+c[0].length)return this.selectionEnd+=c[0].length,c[0]},extendLeftSelection:function(a){var c=this.textArea.val().slice(0,this.selectionStart);a=RegExp(a.source+"$");if(a=a.exec(c))return this.selectionStart-=a[0].length,a[0]}};m.prototype={getButton:function(){return'<a href="#" class="'+
this.name+'" ><span>'+this.name+"</span></a>"}};e.prototype={getButton:function(){var a='<select class="'+this.name+'">',c=this.options.length,d;a.className=this.name;for(d=0;d<c;d+=1)a+='<option value="'+this.options[d][0]+'">'+this.options[d][1]+"</option>";return a+"</select>"}};u.prototype={loadModeToolbar:function(){var a=this.editor.currentMode.supportedItems,c=this.editor.settings.save,d=this.visibleItems,h=[];this.div.children().each(function(){var k=this.className;a.indexOf(k)!=-1&&(k!==
"save"||c)?((!d||d.indexOf(k)==-1)&&f(this).show(),h.push(k)):(!d||d.indexOf(k)!=-1)&&f(this).hide()});this.visibleItems=h},runAction:function(a,c){var d=l[a],h=this.editor,k=h.currentMode;(d[k.id]||d).clicked(h,k,c);a!="changeMode"&&!h.is("wysiwyg")&&k.updatePreview()},setActive:function(a){a&&this.div.children().each(function(){var c=this.className.split(" ")[0];if(a[c]=="disable")this.disabled=!0,this.className=c+" disabled";else if(this.disabled=!1,this.className=c,a[c]===!0)this.className=c+
" on";else if(a[c])this.value=a[c]})}};s.prototype={changeMode:function(a){if(!a||a===this.currentMode.id)return!1;a=this.getMode(a);this.commit();this.currentMode=a;a.activate()},getDataMode:function(){return this.getMode(this.dataType)},getMode:function(a){if(this.loadedModes[a])return this.loadedModes[a];else if(j[a])return this.loadedModes[a]=j[a](this),this.loadedModes[a];else console.log("Mode "+a+" is not defined")},setDataType:function(a){var c,d=a.split(/\s+/);for(a=0;a<d.length;a+=1)if(c=
d[a],c!=="wysiwyg"&&j[c])this.dataType=c},commit:function(){this.is("wysiwyg")?this.getMode(this.dataType).updateTextArea():this.currentMode.updatePreview()},is:function(a){return this.currentMode.id===a},checkState:function(){this.toolbar.setActive(this.currentMode.getStates())}};var n={addMode:function(a,c){var d=c(),h=d.items,k,n=t.slice();d.id=a;if(h)for(item in h)h.hasOwnProperty(item)&&item!=="default"&&(n.push(item),l[item]||(k=h[item].options?e:m,l[item]=new k(item)),l[item][a]=f.extend({name:item},
h["default"],h[item]));l.changeMode.options.push([a,d.name]);d.supportedItems=n;j[a]=function(a){var c=new b(d);c.load(a);return c};return d},options:{},setOptions:function(a){this.options=a}};f.fn.initMarkupEditor=function(a){n.settings=a;this.each(function(c,d){var h=f(d);if(h.is("textarea"))q(h,a);else{h.css("min-height",h.height());var k;k=f('<textarea class="'+h[0].className+'">').prependTo(h);k=q(k,a);k.htmlDiv.append(k.container.nextAll());k.currentMode.updateTextArea();k.changeMode("wysiwyg");
k.toolbar.setActive({changeMode:"wysiwyg"});h.append(k.container)}});return this};l.changeMode=new e("changeMode",[],function(a,c,d){a.changeMode(d.value)});l.formatBlock=new e("formatBlock",[["p","Paragraph"],["h1","Heading 1"],["h2","Heading 2"],["h3","Heading 3"]]);l.save=new m("save",function(a){a.commit();a.settings.save(a)});return n}(jQuery);
(function(f){neutralKeys="9.16.17.18.20.27.33.34.35.36.37.38.39.40.45.91.93.93";f.util={isNeutralKey:function(b){return neutralKeys.indexOf(""+b)!=-1},isRemovalKey:function(b){return b==46||b==8}}})(ME);
(function(f,b){var m=b.util.isNeutralKey,e=b.util.isRemovalKey;f.fn.enhanceTextfield=function(b){b=b||{};return this.each(function(){function u(){g.css("color","grey").data("hasPrompt",!0).val(b.prompt)}function s(){g.css("color",p).data("hasPrompt",!1).val("")}function q(){g.val()&&g.val()!==b.prompt?(g.css("color",p),j.show()):(u(),j.hide(),l=!1)}var g=f(this),j,l,p=g.css("color");g.is("input")&&(j=f("<span>x</span>").click(function(){s();g.focus();j.hide();l=!1}),$p=g.wrap('<span class="clearButton">').focus(function(){!l&&
g.val()===b.prompt&&s();g.parent().addClass("focus")}).focusout(function(){!l&&!g.val()&&u();g.parent().removeClass("focus")}).keydown(function(j){!m(j.which)&&(!l||e(j.which))&&g.val()===b.prompt&&s()}).keyup(function(b){!l&&!m(b.which)&&!e(b.which)&&(l=!0,q())}).bind("blur change",function(){q()}).submit(function(){g.val()===b.prompt&&s()}).parent().append(j),g.hasClass("ui-corner-left")?$p.addClass("ui-corner-left"):$p.addClass("ui-corner-all"))})}})(jQuery,ME);
(function(f,b){f.fn.required=function(b){return this.each(function(){b?f(this).addClass("required"):f(this).removeClass("required")})};f.widget("ui.combobox",{_create:function(){var m=this.element,e=this.options.key,r=f.ui.autocomplete.escapeRegex;m.autocomplete({delay:0,minLength:0,source:function(f,m){var q=RegExp(r(f.term),"i"),g=b.options[e]||[],j=g.length,l=[],p,o;if(f.term)for(o=0;o<j;o++)p=g[o],q.test(p)&&l.push({label:p.replace(RegExp("(?![^&;]+;)(?!<[^<>]*)("+r(f.term)+")(?![^<>]*>)(?![^&;]+;)",
"gi"),"<strong>$1</strong>"),value:p});else l=g;m(l)},focus:function(b,e){m.val(e.item.value).change()}}).addClass("ui-corner-left");m.data("autocomplete")._renderItem=function(b,e){return f("<li></li>").data("item.autocomplete",e).append("<a>"+e.label+"</a>").appendTo(b)};this.button=f("<button type='button'>&nbsp;</button>").attr("tabIndex",-1).attr("title","Show All Items").insertAfter(m).button({icons:{primary:"ui-icon-triangle-1-s"},text:!1}).removeClass("ui-corner-all").addClass("ui-corner-right ui-button-icon").click(function(){m.autocomplete("widget").is(":visible")?
m.autocomplete("close"):(m.data("hasPrompt")&&m.val(""),m.autocomplete("search",""),m.focus())})},destroy:function(){this.button.remove();f.Widget.prototype.destroy.call(this)}})})(jQuery,ME);
(function(f){function b(b,f,m){var g=f.length,j=b.find(":first-child");b.dialog({autoOpen:!1,width:600,close:function(){e.close&&e.close();for(i=0;i<g;i++)f[i].val("").removeAttr("checked").removeAttr("selected")},open:function(){for(i=0;i<g;i++)f[i].change();f[0][0].setSelectionRange(0,0);j.isValid("reset")}});return{dialog:function(f,g){g&&(e=g);b.dialog(f)},find:function(e){return b.find(e)},selectButtons:function(e){for(var f={},g=e.length;g--;)f[e[g]]=m[e[g]];b.dialog("option","buttons",f)},
val:function(b,e){this.find(b).val(e)}}}function m(m,s){var q,g,j,l,p,o,t,n=s.length,a=[];q=f('<div id="'+m+'-dialog" title="'+r[m+"Title"]+'"><form>');var c=q.find(":first-child");for(j=0;j<n;j++){l=s[j][0];p=s[j][1];c.append('<label for="'+l+'">'+r[l]+"</label>");a[j]=f('<input type="text" class="'+l+'" name="'+l+'">').appendTo(c);if(p)for(o in p)p.hasOwnProperty(o)&&(t=p[o],a[j][o](t));a[j].enhanceTextfield({prompt:r[l+"Prompt"]})}submit=function(){var d=[],h;for(h=0;h<n;h++)d[h]=a[h].submit().val();
c.isValid()&&(e.submit.apply(this,d),q.dialog("close"))};g=b(q,a,{Create:submit,Update:submit,Remove:function(){e.remove();q.dialog("close")},Cancel:function(){q.dialog("close")}});return function(a){g.selectButtons(a);return g}}var e;f.fn.isValid.init();var r={linkTitle:"Link",insertImageTitle:"Image",uri:"Link",uriPrompt:"Enter or select link",title:"Title",titlePrompt:"Enter title",imageUri:"Image Source"};ME.dialog={link:m("link",[["title",{required:!0}],["uri",{combobox:{key:"uri"},required:!0}]]),
insertImage:m("insertImage",[["imageUri",{combobox:{key:"imageUri"},required:!0}],["title"],["uri",{combobox:{key:"uri"}}]])}})(jQuery);
ME.addMode("textile",function(){function f(a,c){var d=a.getParagraphs(),h=d.length;for(i=0;i<h;i++)d[i]=c(d[i]);a.setParagraphs(d)}function b(a,c){var d=a.length,h,b,e;for(h=0;h<d;h++)b=a[h],/^\s*$/.test(b)||(b=b.match(/^((?:\w+\. )?(?: *[\*#] )?)\s*(.*)/),e=b[1],b=b[2],c(h,e,b))}function m(a,c,d){var h=a.getSelection(c).split("\n");b(h,function(a,c,b){h[a]=d(c,b)});a.replaceSelection(h.join("\n"))}function e(a){var c=a.getSelection("\n").split("\n").slice(0,1);a.selectionEnd=a.selectionStart+c[0].length;
b(c,function(d,b,k){a.selectionStart+=b.length;c[d]=k});return c[0]}function r(a,c){f(a,function(a){var b,k,e=[];if(/^\w+\([^)]+\)\./.test(a)){b=jQuery.trim(a.slice(a.indexOf("(")+1,a.indexOf(")"))).split(/\s+/);k=b.length;for(i=0;i<k;i++)b[i]!="right"&&b[i]!="left"&&b[i]!="center"&&e.push(b[i]);e.push(c);return a.replace(/^(\w+)[^.]+.\s+/,"$1("+e.join(" ")+"). ")}else return/^\w+\./.test(a)?a.replace(/^(\w+)\.\s*/,"$1("+c+"). "):"p("+c+"). "+a})}function u(a,c){var d=c.exec(q);if(c.lastIndex!==0){for(;c.lastIndex<
g;)d=c.exec(q);a.selectionStart=c.lastIndex-d[0].length;a.selectionEnd=c.lastIndex;return d}}function s(a,c,d){m(a,"\n",function(a,b){/ on$/.test(c.className)||(b=d+" "+b);return b})}var q,g,j,l,p,o={},t=jQuery,n={ul:"*",ol:"#"};regexpes={"*":[/^(\w+\. )?\s*\*/,/\*([\.]*)$/],_:[/^(\w+\. )?\s*_/,/_([\.]*)$/]};return{name:"Textile Mode",items:{"default":{clicked:function(a,c,d){var b,e=this;m(c," ",function(a,n){/ on$/.test(d.className)?(n=(b=n.match(regexpes[e.delimiter][0]))?(b[1]||"")+n.slice(b[0].length):
e.delimiter+c.extendLeftSelection(/[ .]+/)+n,(b=n.match(regexpes[e.delimiter][1]))?n=n.slice(0,-b[0].length)+(b[1]||""):n+=c.extendRightSelection(/ +/)+e.delimiter):n=t.trim(e.delimiter+n)+e.delimiter;return a+n})}},bold:{delimiter:"*"},italic:{delimiter:"_"},alignLeft:{clicked:function(a,c){r(c,"left")}},alignRight:{clicked:function(a,c){r(c,"right")}},alignCenter:{clicked:function(a,c){r(c,"center")}},unorderedList:{clicked:function(a,c,d){s(c,d,"*")}},orderedList:{clicked:function(a,c,d){s(c,d,
"#")}},link:{clicked:function(a,c,d){var b,n,f;/ on$/.test(d.className)?(d=ME.dialog.link(["Update","Remove","Cancel"]),n=o.a.attributes.href,f=u(c,RegExp('"([^"]*)":'+n,"g")),b=f[1],d.val("input.uri",n)):(d=ME.dialog.link(["Create","Cancel"]),b=e(c));/^\s*$/.test(b)||d.val(".title",b);d.dialog("open",{submit:function(a,d){c.replaceSelection('"'+a+'":'+d)},remove:function(){c.replaceSelection(f[1])},close:function(){c.updatePreview();a.checkState()}})}},insertImage:{clicked:function(a,c,d){var b,
n;if(/ on$/.test(d.className)){d=ME.dialog.insertImage(["Update","Remove","Cancel"]);n=o.img.attributes.src;u(c,RegExp("!"+n+"(\\([^\\)]*\\))?!(:[^ \n]*)?","g"));if(o.a)b=o.a.attributes.href;d.val("input.uri",b);d.val("input.imageUri",n);d.val("input.title",o.img.attributes.title)}else d=ME.dialog.insertImage(["Create","Cancel"]),e(c);d.dialog("open",{submit:function(a,d,b){d&&!/^\s*$/.test(d)&&(a=a+"("+d+")");a="!"+a+"!";b&&!/^\s*$/.test(b)&&(a=a+":"+b);c.replaceSelection(a)},remove:function(){c.replaceSelection("")},
close:function(){c.updatePreview();a.checkState()}})}},formatBlock:{clicked:function(a,c,d){f(c,function(a){return/^\w+(\([\w ]+\))?\./.test(a)?a.replace(/^\w+(\([\w ]+\))?\.\s+/,d.value+"$1. "):/^[\*#] /.test(a)?a:d.value+". "+a})}}},updatePreview:function(){this.htmlDiv.html(textileCompiler.compile(this.textArea.val()))},toText:function(a){a||(a=this.htmlDiv.html());a=a.replace(/\s*<(ul|ol)>((.|[\r\n])*?)<\/\1>\s*/gi,function(a,d,b){return b.replace(/\s*<li>((.|[\r\n])*?)<\/li>\s*/gi,(d=="ul"?"*":
"#")+" $1\n")+"\n"});a=a.replace(/ *<(p|h[1-4])([^>]*)>((.|[\r\n])*?)<\/\1>\s*/gi,function(a,d,b,n){a="";(b=b.match(/class=\"([^"]*)/))?a=d+"("+b[1]+"). ":d!="p"&&(a=d+". ");return a+n.replace(/<br ?\/?>\s*/gi,"\n")+"\n\n"});a=a.replace(/<(?:b|strong)>((.|[\r\n])*?)<\/(?:b|strong)>/gi,"*$1*");a=a.replace(/<(?:i|em)>((.|[\r\n])*?)<\/(?:i|em)>/gi,"_$1_");a=a.replace(/<(?:strike|del)>((.|[\r\n])*?)<\/(?:strike|del)>/gi,"-$1-");a=a.replace(/<(?:u|ins)>((.|[\r\n])*?)<\/(?:u|ins)>/gi,"+$1+");a=a.replace(/<img[^>]*>/gi,
function(a){var d=t(a);a=d.attr("src");(d=d.attr("title"))&&!/^\s*$/.test(d)&&(a=a+"("+d+")");return"!"+a+"!"});a=a.replace(/<a href="([^\"]*)">((.|[\r\n])*?)<\/a>/gi,function(a,d,b){return/^\s*![^!]+!\s*$/.test(b)?t.trim(b)+":"+d:'"'+b+'":'+d});a=a.replace(/\s*<code[^>]*>((.|[\r\n])*?)<\/code>\s*/gi," @$1@ ");a=a.replace(/(\r\n|\n){3,}/g,"\n\n");a=a.replace(/&nbsp;/g," ");return a=a.replace(/^[\r\n]+|[\r\n]+$/g,"")},getStates:function(){var a=this.getExtendedSelection();trace=textileCompiler.trace(a,
g-j,selectionEnd-j);return this.buildStateObject(trace,o={})},getExtendedSelection:function(){var a;a=0;g=this.textArea[0].selectionStart;selectionEnd=this.textArea[0].selectionEnd;q=this.textArea.val();j=0;for(l=-1;(a=q.indexOf("\n\n",a)+2)!==1;)if(g>a)j=a;else if(selectionEnd<a){l=a-2;break}a=l===-1?q.slice(j):q.slice(j,l);p=a.length;return a},getParagraphs:function(){return this.getExtendedSelection().split(/\n\n+/)},setParagraphs:function(a){a=a.join("\n\n");l===-1?this.textArea.val(q.slice(0,
j)+a):this.textArea.val(q.slice(0,j)+a+q.slice(l));this.moveCaret(a.length-p)},moveCaret:function(a){console.log("Moving caret: "+a);Math.abs(g-j)>Math.abs(a)?g+=a:g=j;this.textArea.focus();this.textArea[0].setSelectionRange(g,g)},pressed:function(a){switch(a){case 13:var c;if((a=o.list)&&/(u|o)l/i.test(a.tag))this.getSelection(),c=this.holdShift?" <br> ":"\n"+n[a.tag]+" ",this.replaceSelection(c,!1),c=!1;return c;default:this.prototype.pressed.apply(this,[a])}}}});
textileCompiler=function(){function f(e){e=e.exec(m);var f,u;if(e)return f=/^\s*/.exec(e[0])[0].length,u=e[0].length,f&&b.advancePointer(f,!0),u-f&&b.advancePointer(u-f),m=m.slice(u),e||!0}var b=function(){function b(a,c){var d=["class"],n;w[a]&&(d=d.concat(w[a]));for(n=d.length;n--;)c(d[n])}function f(a){var c=!0,d=l==-1,n,h,k;if(d)/(o|u)l/.test(j[0].tag)?(/(o|u)l/.test(a.tag)&&a.tag!=j[0].tag&&(a={tag:"p"}),n=j[0]=a):n=j[0];else{h=l+1;for(k=j.length;h<k;h++)if(j[h].tag===a.tag){n=j[h];j[h]=j[l+
1];j[l+1]=n;break}}n&&n.attributes&&b(n.tag,function(d){n.attributes[d]!==a.attributes[d]&&(c=!1,delete n.attributes[d])});return n&&(d||c)}function m(a){this.tag=a.tag;this.attributes=a.attributes}function s(a){var c="";for(attr in a.attributes)a.attributes.hasOwnProperty(attr)&&(c+=" "+attr+'="'+a.attributes[attr]+'"');return"<"+a.tag+c+">"}function q(a){var c;for(c=g.length;c--;)if(g[c].tag===a)return c}var g,j,l,p,o,t,n,a,c,d,h=!1,k,v=["li"],w={img:["title","src"],a:["href"]};return{init:function(){g=
[{content:""}]},initTrace:function(d,b,e){j=[];c=void 0;t=0;n=d;a=b;k=e},finalizeTrace:function(){c&&(c=d=!1)},advancePointer:function(b,e){t+=b;if(c===void 0&&(t>n||t==k)){var h=g.length,f,o=0;p=c=!0;for(f=1;f<h;f++)v.indexOf(g[f].tag)==-1?j[f-1-o]=new m(g[f]):o+=1;l=j.length-1}c&&t>a&&(d||e?c=d=!1:d=!0)},pushTag:function(a,d){var b={tag:a,attributes:d||{},content:""};g.push(b);c&&v.indexOf(a)==-1&&(p?(j[l+1]=new m(b),l+=1):j[l+1]&&(f(b)?l+=1:h=!0))},closeTag:function(a){var d,b;a?(b=q(a),d=g.splice(b,
1)[0]):d=g.pop();c&&v.indexOf(a)==-1&&(p=!1,h&&(j=j.slice(0,l+1),h=!1),j[l].tag===d.tag&&(l-=1),o=!0);this.pushString(s(d)+d.content,g[b-1]);this.pushString("</"+d.tag+">");o=!1},popLineEnd:function(){for(var a=!1,c={b:"*",i:"_"},d;"a,i,b,li".indexOf(g[g.length-1].tag)!=-1;)"li"===g[g.length-1].tag?(this.closeTag(),a=!0):(d=g.pop(),this.pushString(c[d.tag]+d.content));return a},popParagraphEnd:function(){for(;g.length>1;)this.closeTag()},pushString:function(a,d){d||(d=g[g.length-1]);d.content+=a;
/^([ ]+|<br\/>)?$/.test(a)||(p&&(p=!1),c&&!o&&j[l+1]&&(j=j.slice(0,l+1)))},isOpen:function(a){return typeof q(a)==="number"},blockTagIsOpen:function(){return!!g[1]},closeBlockTag:function(){for(;g[1];)this.closeTag()},getTrace:function(){return j},toHtml:function(){return g[0].content}}}(),m;return{compile:function(e){b.init();for(m=e;!/^\s*$/.test(m);){if(e=f(/^\s*(h\d|p|bq)(\(([^#\)]*)(#[^\)]+)?\))?\. /)){var r={};e[3]&&(r["class"]=e[3]);if(e[4])r.id=e[4];b.pushTag(e[1],r)}for(;!f(/^\n/)&&!/^\s*$/.test(m);){e=
void 0;if(f(/^ *\* /))b.isOpen("ul")||(b.closeBlockTag(),b.pushTag("ul")),b.pushTag("li");else if(f(/^ *# /))b.isOpen("ol")||(b.closeBlockTag(),b.pushTag("ol")),b.pushTag("li");else{for(;b.isOpen("ul")||b.isOpen("ol");)b.closeTag();b.blockTagIsOpen()||b.pushTag("p")}e=f(/^ */);b.pushString(e[0]);for(e=e=void 0;;)if(f(/^_(?=[^ \n]+)/))b.isOpen("i")?b.pushString("_"):b.pushTag("i");else if(f(/^\*(?=[^ \n]+)/))b.isOpen("b")?b.pushString("*"):b.pushTag("b");else if(e=f(/^([^ \n]+)_( +|(?=\n|$))/))b.isOpen("i")?
(b.pushString(e[1]),b.closeTag("i"),b.pushString(e[2])):b.pushString(e[1]+"_"+e[2]);else if(e=f(/^([^ \n]+)\*( +|(?=\n|$))/))b.isOpen("b")?(b.pushString(e[1]),b.closeTag("b"),b.pushString(e[2])):b.pushString(e[1]+"*"+e[2]);else if(e=f(/^( *)"([^"]*)":([^ \n]+)/))b.pushString(e[1]),b.pushTag("a",{href:e[3]}),b.pushString(e[2]),b.closeTag();else if(e=f(/^( *)!([^!\(]+)(\(([^\)]*)\))?!(:([^ \n]+))?/)){b.pushString(e[1]);e[6]&&b.pushTag("a",{href:e[6]});r={src:e[2]};if(e[4])r.title=e[4];b.pushTag("img",
r);b.closeTag();e[6]&&b.closeTag()}else if(e=f(/^([^ \n]+)/))b.pushString(e[1]);else if(e=f(/^( +)/))b.pushString(e[1]);else{f(/^\n/);e=b.popLineEnd();!e&&!/^\s*(\n|$|[\*#] )/.test(m)&&b.pushString("<br/>");break}}b.popParagraphEnd()}return b.toHtml()},trace:function(e,f,m){b.initTrace(f,m,e.length);this.compile(e);b.finalizeTrace();return b.getTrace()}}}();
ME.addMode("wysiwyg",function(){function f(b){return b.parent().is(".preview")?b:b.parentsUntil(".preview").last()}function b(){var b,a,c=-1;b=f(jQuery(o.getRangeAt(0).startContainer));a=f(jQuery(o.getRangeAt(0).endContainer))[0];return b[0]!==a?b.nextAll().filter(function(d){this==a&&(c=d);if(c===-1||c===d)return!0}).add(b):b}function m(n){b().removeClass("left").removeClass("right").removeClass("center").addClass(n)}function e(b,a){var c=b[0],d;b.length>1?(d=b[b.length-1],t.setStart(c,0),t.setEnd(d,
d.childNodes.length)):t.selectNodeContents(c);a!==void 0&&t.collapse(a);o.removeAllRanges();o.addRange(t)}function r(b,a,c,d){/ on$/.test(c.className)?(c=a.getSelection("li"),d=[],g(d,c.firstChild),c=p("<p>").html(d.join("<br>")),a.replaceSelection(b,c)):(c=a.getSelection("br"),d=p("<"+d+">"),s(d,c.firstChild),q(a.leftBorder,d),q(a.rightBorder,d),a.replaceSelection(b,d))}function u(b,a,c){this.nextProperty=c;this.ancestors=b.parentsUntil(".preview");this.block=this.ancestors[this.ancestors.length-
1]||b[0];for(this.borderNode=this.ancestors[this.ancestors.length-2]||b[0];this.borderNode;){this.node=this.borderNode;if(this.borderNode.nodeName.toLowerCase()===a)break;this.borderNode=this.borderNode[c]}this.safeBlock=this.borderNode?this.block:this.block[c]}function s(b,a){function c(){/^\s*$/.test(d.textContent)||b.append(d);d=document.createElement("li")}for(var d=document.createElement("li"),e;a!==null;)e=a.nextSibling,/br/i.test(a.nodeName)?c():/(p|h\d)/i.test(a.nodeName)?(c(),s(b,a.firstChild)):
/(o|u)l/i.test(a.nodeName)?p(a).children().appendTo(b):/li/i.test(a.nodeName)?(c(),b.append(a)):d.appendChild(a),a=e;c()}function q(b,a){var c;if(b.safeBlock&&/ul/i.test(b.safeBlock.nodeName))next=b.safeBlock[b.nextProperty],c=p(b.safeBlock).remove().children(),b.nextProperty==="previousSibling"?c.prependTo(a):c.appendTo(a),b.safeBlock=next}function g(b,a){for(;a;)/(o|u)l/i.test(a.nodeName)?g(b,a.firstChild):/li/i.test(a.nodeName)&&b.push(a.innerHTML),a=a.nextSibling}function j(b,a){var c=o.getRangeAt(0);
if(!p.browser.mozilla||c.collapsed||ME.util.isNeutralKey(a))return!0;c=c.extractContents();if(b.is(":empty")||/^ *$/.test(b.text()))return c=document.createElement(c.childNodes[0].nodeName),b.html(c),e([c]),/^8|13|46$/.test(""+a)?!1:!0}var l={},p=jQuery,o=getSelection(),t=document.createRange();return{name:"Preview Mode",items:{"default":{clicked:function(b,a,c){b=o.getRangeAt(0);/ on$/.test(c.className)?document.execCommand(this.name,!1,null):(c=document.createElement(this.tag),b.surroundContents(c),
o.removeAllRanges(),o.addRange(b))}},bold:{tag:"b"},italic:{tag:"i"},alignLeft:{clicked:function(){m("left")}},alignRight:{clicked:function(){m("right")}},alignCenter:{clicked:function(){m("center")}},unorderedList:{clicked:function(b,a,c){r(b,a,c,"ul")}},orderedList:{clicked:function(b,a,c){r(b,a,c,"ol")}},link:{clicked:function(b,a,c){var d,e,f=o.getRangeAt(0);a={remove:function(){var a=d.text();d.replaceWith(a)},close:function(){b.htmlDiv.focus();b.checkState()}};/ on$/.test(c.className)?(d=p(l.a),
c=ME.dialog.link(["Update","Remove","Cancel"]),a.submit=function(a,c){d.attr("href",c).text(a);f.selectNodeContents(d[0]);o.removeAllRanges();o.addRange(f)},e=d.text(),c.val("input.uri",d.attr("href"))):(c=ME.dialog.link(["Create","Cancel"]),a.submit=function(a,c){var d=p('<a href="'+c+'">'+a+"</a>")[0];f.deleteContents();f.insertNode(d);f.selectNodeContents(d);o.removeAllRanges();o.addRange(f)},e=f.toString());/^\s*$/.test(e)||c.val(".title",e);c.dialog("open",a)}},insertImage:{clicked:function(b,
a,c){var d=window.getSelection(),e=d.getRangeAt(0);/ on$/.test(c.className)?(a=ME.dialog.insertImage(["Update","Remove","Cancel"]),l.a&&(c=p(l.a),a.val("input.uri",c.attr("href")),e.selectNode(l.a)),imageNode=p(l.img),a.val("input.imageUri",imageNode.attr("src")),a.val("input.title",imageNode.attr("title"))):a=ME.dialog.insertImage(["Create","Cancel"]);a.dialog("open",{submit:function(a,c,b){var f=a=p('<img src="'+a+'"/>');/^\s*$/.test(c)||a.attr({alt:c,title:c});/^\s*$/.test(b)||(f=p('<a href="'+
b+'"/>').append(a));e.deleteContents();e.insertNode(f[0]);e.selectNode(a[0]);d.removeAllRanges();d.addRange(e)},remove:function(){imageNode.remove()},close:function(){b.htmlDiv.focus();b.checkState()}})}},formatBlock:{clicked:function(f,a,c){var d,h=[],g;b().replaceWith(function(){g=/(u|o)l/i.test(this.nodeName)?this.nodeName:c.value;d=p("<"+g+">").addClass(this.className).append(this.childNodes);h.push(d[0]);return d});e(h)}}},getSelection:function(){var b=o.getRangeAt(0);this.leftBorder=new u(jQuery(o.getRangeAt(0).startContainer),
"li","previousSibling");this.rightBorder=new u(jQuery(o.getRangeAt(0).endContainer),"li","nextSibling");b.setStartBefore(this.leftBorder.node);b.setEndAfter(this.rightBorder.node);return b.extractContents()},replaceSelection:function(b,a){this.leftBorder.safeBlock?a.insertAfter(this.leftBorder.safeBlock):b.htmlDiv.prepend(a);e(a);/^\s*$/.test(this.leftBorder.block.textContent)&&p(this.leftBorder.block).remove();/^\s*$/.test(this.rightBorder.block.textContent)&&p(this.rightBorder.block).remove()},
afterActivation:function(){this.textArea.parent().hide();this.htmlDiv.attr("contentEditable",!0);p.browser.mozilla&&document.execCommand("styleWithCSS",null,!1)},getStates:function(){function b(a,c){c&&c.nodeName!="#text"&&a[0].nodeName!="#text"&&(a=a.find(c.nodeName.toLowerCase()));return a.parentsUntil(".preview").add(a)}if(p(document.activeElement).is(".preview")){var a=[],c;c=o.getRangeAt(0).cloneContents().firstChild;a=b(jQuery(o.getRangeAt(0).startContainer),c);c=b(jQuery(o.getRangeAt(0).endContainer),
c);/(u|o)l/i.test(a[0].nodeName)&&a[0].nodeName!==c[0].nodeName&&(a=a.toArray(),a[0]=p("<p>")[0]);return this.buildStateObject(a,l={})}},pressed:function(b){switch(b){case 13:var a;var c=this.htmlDiv;if(j(c,13)===!1)a=!1;else{b=!0;var d,f,g,m=l.block;if(/h[1-5]/i.test(m.nodeName)){f=o.getRangeAt(0);for(d=g=f.endContainer;d.parentNode!==c[0];){if(d.nextSibling){b=!1;break}d=d.parentNode}b&&f.endOffset===g.textContent.length&&(d=p("<p>").insertAfter(m),e(d),a=!1)}}return a;case 8:b=this.htmlDiv;if(j(b,
8)===!1)c=!1;else if(p.browser.webkit){d=!0;g=l.block;f=o.getRangeAt(0);for(a=f.startContainer;a.parentNode!==b[0];){if(a.previousSibling){d=!1;break}a=a.parentNode}d&&f.startOffset===0&&(a=p(g),b=a.contents(),d=a.prev(),d[0]&&(d.append(b),a.remove(),e([b[0]],!0),c=!1))}else c=!0;return c;default:return j(this.htmlDiv,b)}},toText:function(){return this.editor.getDataMode().toText()},toHTML:function(){return this.htmlDiv.html()}}});
