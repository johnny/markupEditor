ME=function(l){function d(a){l.extend(this,a)}function n(a){this.name=a}function b(a,c){this.name=a;this.options=c||[]}function j(a){var c=l('<div class="toolbar"></div>'),g=this;this.textArea=a.textArea;this.htmlDiv=a.htmlDiv;this.editor=a;this.div=c;for(item in k)k.hasOwnProperty(item)&&c.append(k[item].getButton());c.mouseup(function(c){c=c.target;if(!/(select|option)/i.test(c.nodeName)){if(/span/i.test(c.nodeName))c=c.parentNode;var e=c.className;e=e.split(" ")[0];g.runAction(e,c);a.checkState()}return!1}).change(function(a){a=
a.target;g.runAction(a.className,a);return!1});a.container.prepend(c)}function f(a){var c=this;this.loadedModes={};this.setDataType(a.attr("class"));if(this.dataType)this.textArea=a.bind("mouseup keyup",function(){c.checkState()}),this.htmlDiv=l('<div class="preview"></div>').bind("mouseup keyup",function(){c.is("wysiwyg")&&c.checkState()}),this.container=a.wrap('<div class="markupEditor"></div>').parent().append(c.htmlDiv),this.toolbar=new j(c)}function m(a,c,g){if(c)for(element in c)c.hasOwnProperty(element)&&
element!=="default"&&(k[element]||(k[element]=new a(element)),k[element][g]=l.extend({name:element},c["default"],c[element]))}var h={},e={},k={};d.prototype={load:function(a){this.editor=a;this.htmlDiv=a.htmlDiv;this.textArea=a.textArea;console.log("loaded Mode "+this.name)},getStates:l.noop,activate:function(){this.htmlDiv.is(":empty")?this.updatePreview():this.updateTextArea();this.afterActivation()},updatePreview:function(){console.log("updating preview in Mode "+this.name);this.htmlDiv.html(this.toHTML())},
updateTextArea:function(){console.log("updating TA in Mode "+this.name);this.textArea.val(this.toText())},afterActivation:function(){this.textArea.show();this.htmlDiv.attr("contentEditable",!1)},buildStateObject:function(a,c){for(var g,e=a.length,b={};e--;)switch(g=a[e],g.tag?g.tag:g.nodeName.toLowerCase()){case "a":c.a=g;b.link=!0;break;case "img":c.img=g;b.insertImage=!0;break;case "i":b.italic=!0;break;case "li":break;case "ol":b.insertOrderedList=!0;b.insertUnorderedList=!1;break;case "b":b.bold=
!0;break;case "ul":b.insertOrderedList=!1;b.insertUnorderedList=!0;break;default:b.formatBlock=g.tag?g.tag:g.nodeName.toLowerCase()}return b}};n.prototype={getButton:function(){return'<a href="#" class="'+this.name+'" ><span>'+this.name+"</span></a>"}};b.prototype={getButton:function(){var a=l('<select class="'+this.name+'"></select>'),c=this.options.length,g;a.className=this.name;for(g=0;g<c;g+=1)l("<option/>").val(this.options[g][0]).text(this.options[g][1]).appendTo(a);return a}};j.prototype={getDivSelection:function(){this.htmlDiv.focus();
theSelection=window.getSelection();theRange=theSelection.getRangeAt(0);return theRange.toString()},getTextAreaSelection:function(a){var c=this.textArea,g=c.val();c.focus();this.scrollPosition=c.scrollTop;this.selectionStart=c[0].selectionStart;this.selectionEnd=c[0].selectionEnd;if(a){a=Math.max(g.lastIndexOf(" ",this.selectionStart),g.lastIndexOf("\n",this.selectionStart));this.selectionStart=a!==-1?a+1:0;a=g.indexOf("\n",this.selectionEnd);c=a===-1?g.slice(this.selectionStart):g.slice(this.selectionStart,
a);a=0;do a=c.indexOf(" ",a+1);while(a!==-1&&this.selectionEnd>this.selectionStart+a);if(a===-1)a=c.length;this.selectionEnd=this.selectionStart+a}return this.selection=g.slice(this.selectionStart,this.selectionEnd)},replaceTextAreaSelection:function(a){var c=this.textArea,g=this.selectionStart;c.val(c.val().slice(0,this.selectionStart)+a+c.val().slice(this.selectionEnd,c.val().length));c[0].setSelectionRange(g,g+a.length);c.focus()},extendRightSelection:function(a){var c;a=RegExp(a.source,"g");a.lastIndex=
this.selectionEnd;if((c=a.exec(this.textArea.val()))&&a.lastIndex==this.selectionEnd+c[0].length)return this.selectionEnd+=c[0].length,c[0]},extendLeftSelection:function(a){var c=this.textArea.val().slice(0,this.selectionStart);a=RegExp(a.source+"$");if(a=a.exec(c))return this.selectionStart-=a[0].length,a[0]},replaceDivSelection:function(){},getSelection:function(a){return this.editor.is("wysiwyg")?this.getDivSelection(a):this.getTextAreaSelection(a)},replaceSelection:function(a){this.editor.is("wysiwyg")?
this.replaceDivSelection(a):this.replaceTextAreaSelection(a)},runAction:function(a,c){k[a][this.editor.currentMode.id].clicked(this,c);a!="changeMode"&&!this.editor.is("wysiwyg")&&this.editor.currentMode.updatePreview()},setActive:function(a){a&&this.div.children().each(function(){var c=this.className.split(" ")[0];a[c]===!0?this.className=c+" on":a[c]?this.value=a[c]:this.className=c})}};f.prototype={changeMode:function(a){if(!a||a===this.currentMode.id)return!1;a=this.getMode(a);this.commit();a.activate();
this.currentMode=a},getDataMode:function(){return this.getMode(this.dataType)},getMode:function(a){if(this.loadedModes[a])return this.loadedModes[a];else if(e[a])return this.loadedModes[a]=e[a](this),this.loadedModes[a];else console.log("Mode "+a+" is not defined")},setDataType:function(a){var c,g=a.split(/\s+/);for(a=0;a<g.length;a+=1)if(c=g[a],c!=="wysiwyg"&&e[c])this.dataType=c},commit:function(){this.is("wysiwyg")?this.getMode(this.dataType).updateTextArea():this.currentMode.updatePreview()},
is:function(a){return this.currentMode.id===a},checkState:function(){this.toolbar.setActive(this.currentMode.getStates())}};l.fn.initMarkupEditor=function(a){this.each(function(c,g){g=l(g);if(g.is("textarea")){var b=g,e;e={};l.extend(e,h,a);e=new f(b,e);e.currentMode=e.getDataMode();if(b.hasClass("wysiwyg"))e.currentMode=e.getMode("wysiwyg");e.currentMode.activate();e.toolbar.setActive({changeMode:e.currentMode.id})}});return this};k.changeMode=new b("changeMode");k.formatBlock=new b("formatBlock",
[["p","Paragraph"],["h1","Heading 1"],["h2","Heading 2"],["h3","Heading 3"]]);return{addMode:function(a,c){var g=c(),j=g.buttons,f=g.selects;g.id=a;m(n,j,a);m(b,f,a);k.changeMode.options.push([a,g.name]);k.changeMode[a]={clicked:function(a,c){a.editor.changeMode(c.value)}};e[a]=function(a){var c=new d(g);c.load(a);return c};return g}}}(jQuery);
ME.dialog=function(l){function d(d,f){fields=d.find(":input");d.dialog({autoOpen:!1,width:600,close:function(){b.close&&b.close();fields.not(":button, :submit, :reset").val("").removeAttr("checked").removeAttr("selected")}});return{dialog:function(f,h){h&&(b=h);d.dialog(f)},find:function(b){return d.find(b)},selectButtons:function(b){for(var h={},e=b.length;e--;)h[b[e]]=f[b[e]];d.dialog("option","buttons",h)},val:function(b,d){this.find(b).val(d)}}}function n(j,f){return function(m){var h,e,k=l("#"+
j+"-dialog");f=f(k);e=f.length;submit=function(){var a=[],c;for(c=0;c<e;c++)a[c]=f[c].val();b.submit.apply(this,a);k.dialog("close")};h=d(k,{Ok:submit,Update:submit,Remove:function(){b.remove();k.dialog("close")},Cancel:function(){k.dialog("close")}});this[j]=function(a){h.selectButtons(a);return h};return this[j](m)}}var b;return{link:n("link",function(b){return[b.find("input.title"),$uri=b.find("input.uri"),b.find("select.uri").change(function(){$uri.val(l(this).val())})]}),insertImage:n("insertImage",
function(b){return[b.find("input.imageUri"),b.find("input.title"),b.find("input.uri")]})}}(jQuery);$(document).ready(function(){$("textarea.markup").initMarkupEditor({})});
ME.addMode("textile",function(){function l(a,c){var b=a.editor.currentMode,e=b.getParagraphs(),d=e.length;for(i=0;i<d;i++)e[i]=c(e[i]);b.setParagraphs(e)}function d(a,c){l(a,function(a){var b,e,d=[];if(/^\w+\([^)]+\)\./.test(a)){b=jQuery.trim(a.slice(a.indexOf("(")+1,a.indexOf(")"))).split(/\s+/);e=b.length;for(i=0;i<e;i++)b[i]!="right"&&b[i]!="left"&&b[i]!="center"&&d.push(b[i]);d.push(c);return a.replace(/^(\w+)[^.]+.\s+/,"$1("+d.join(" ")+"). ")}else return/^\w+\./.test(a)?a.replace(/^(\w+)\.\s*/,
"$1("+c+"). "):"p("+c+"). "+a})}function n(a,c){match=c.exec(b);if(c.lastIndex!==0){for(;c.lastIndex<j;)match=c.exec(b);a.selectionStart=c.lastIndex-match[0].length;a.selectionEnd=c.lastIndex;return match}}var b,j,f,m,h,e={},k=jQuery;regexpes={"*":/^(\w+\. )?\s*\*(.*)\*/};return{name:"Textile Mode",buttons:{"default":{clicked:function(a,c){var b=a.getSelection(!0).split("\n"),e=b.length,d,f;for(d=0;d<e;d++)f=b[d],/^\s*$/.test(f)||(/ on$/.test(c.className)?(f=(match=f.match(/^(\w+\. )?\s*\*/))?(match[1]||
"")+f.slice(match[0].length):"*"+a.extendLeftSelection(/[ .]+/)+f,(match=f.match(/\*([\.]*)$/))?f=f.slice(0,-match[0].length)+(match[1]||""):f+=a.extendRightSelection(/ +/)+"*"):f=k.trim(f.replace(/^(\w+\. )?\s*(.*)/,"$1"+this.delimiter+"$2"))+this.delimiter,b[d]=f);a.replaceSelection(b.join("\n"))}},bold:{delimiter:"*"},italic:{delimiter:"_"},alignLeft:{clicked:function(a){d(a,"left")}},alignRight:{clicked:function(a){d(a,"right")}},alignCenter:{clicked:function(a){d(a,"center")}},link:{clicked:function(a,
c){var b,d,f,k;/ on$/.test(c.className)?(b=ME.dialog.link(["Update","Remove","Cancel"]),f=e.a.attributes.href,k=n(a,RegExp('"([^"]*)":'+f,"g")),d=k[1],b.val("input.uri",f)):(b=ME.dialog.link(["Ok","Cancel"]),d=a.getSelection());/^\s*$/.test(d)||b.val(".title",d);b.dialog("open",{submit:function(c,b){a.replaceSelection('"'+c+'":'+b)},remove:function(){a.replaceSelection(k[1])},close:function(){a.editor.currentMode.updatePreview();a.editor.checkState()}})}},insertImage:{clicked:function(a,c){var b,
d,f;if(/ on$/.test(c.className)){b=ME.dialog.insertImage(["Update","Remove","Cancel"]);f=e.img.attributes.src;n(a,RegExp("!"+f+"(\\([^\\)]*\\))?!(:[^ \n]*)?","g"));if(e.a)d=e.a.attributes.href;b.val("input.uri",d);b.val("input.imageUri",f);b.val("input.title",e.img.attributes.title)}else b=ME.dialog.insertImage(["Ok","Cancel"]),a.getSelection();b.dialog("open",{submit:function(b,c,e){c&&!/^\s*$/.test(c)&&(b=b+"("+c+")");b="!"+b+"!";e&&!/^\s*$/.test(e)&&(b=b+":"+e);a.replaceSelection(b)},remove:function(){a.replaceSelection("")},
close:function(){a.editor.currentMode.updatePreview();a.editor.checkState()}})}}},selects:{formatBlock:{clicked:function(a,b){l(a,function(a){return/^\w+(\([\w ]+\))?\./.test(a)?a.replace(/^\w+(\([\w ]+\))?\.\s+/,b.value+"$1. "):b.value+". "+a})}}},updatePreview:function(){this.htmlDiv.html(textileCompiler.compile(this.textArea.val()))},toText:function(a){a||(a=this.htmlDiv.html());a=a.replace(/\s*<(h[1-4])>((.|[\r\n])*?)<\/\1>\s*/gi,"\n\n$1. $2\n\n");a=a.replace(/\s*<(p)>((.|[\r\n])*?)<\/\1>\s*/gi,
"\n\n$2\n\n");a=a.replace(/\s*<(p|h[1-4]).*class=\"([^\"]+)\">((.|[\r\n])*?)<\/\1>\s*/gi,"\n\n$1($2). $3\n\n");a=a.replace(/<br ?\/?>\s*/gi,"\n");a=a.replace(/<(?:b|strong)>((.|[\r\n])*?)<\/(?:b|strong)>/gi,"*$1*");a=a.replace(/<(?:i|em)>((.|[\r\n])*?)<\/(?:i|em)>/gi,"_$1_");a=a.replace(/<(?:strike|del)>((.|[\r\n])*?)<\/(?:strike|del)>/gi,"-$1-");a=a.replace(/<(?:u|ins)>((.|[\r\n])*?)<\/(?:u|ins)>/gi,"+$1+");a=a.replace(/<img[^>]*>/gi,function(a){var b=k(a);a=b.attr("src");(b=b.attr("title"))&&!/^\s*$/.test(b)&&
(a=a+"("+b+")");return"!"+a+"!"});a=a.replace(/<a href="([^\"]*)">((.|[\r\n])*?)<\/a>/gi,function(a,b,e){return/^\s*![^!]+!\s*$/.test(e)?k.trim(e)+":"+b:'"'+e+'":'+b});a=a.replace(/\s*<code[^>]*>((.|[\r\n])*?)<\/code>\s*/gi," @$1@ ");a=a.replace(/(\r\n|\n){3,}/g,"\n\n");return a=a.replace(/^[\r\n]+|[\r\n]+$/g,"")},getStates:function(){var a=this.getExtendedSelection();trace=textileCompiler.trace(a,j-f,selectionEnd-f);return this.buildStateObject(trace,e={})},getExtendedSelection:function(){var a;
a=0;j=this.textArea[0].selectionStart;selectionEnd=this.textArea[0].selectionEnd;b=this.textArea.val();f=0;for(m=-1;(a=b.indexOf("\n\n",a)+2)!==1;)if(j>a)f=a;else if(selectionEnd<a){m=a-2;break}a=m===-1?b.slice(f):b.slice(f,m);h=a.length;return a},getParagraphs:function(){return this.getExtendedSelection().split(/\n\n+/)},setParagraphs:function(a){a=a.join("\n\n");m===-1?this.textArea.val(b.slice(0,f)+a):this.textArea.val(b.slice(0,f)+a+b.slice(m));this.moveCaret(a.length-h)},moveCaret:function(a){console.log("Moving caret: "+
a);Math.abs(j-f)>Math.abs(a)?j+=a:j=f;this.textArea.focus();this.textArea[0].setSelectionRange(j,j)}}});
textileCompiler=function(){function l(b){b=b.exec(n);var j,f;if(b)return j=/^\s*/.exec(b[0])[0].length,f=b[0].length,j&&d.advancePointer(j),f-j&&d.advancePointer(f-j),n=n.slice(f),b||!0}var d=function(){function b(a,b){var c=["class"],e;definableAttributes[a]&&(c=c.concat(definableAttributes[a]));for(e=c.length;e--;)b(c[e])}function d(a){var c=!0,f=k==-1,g,j,h;if(f)g=e[0];else{j=k+1;for(h=e.length;j<h;j++)if(e[j].tag===a.tag){g=e[j];e[j]=e[k+1];e[k+1]=g;break}}g&&g.attributes&&b(g.tag,function(b){g.attributes[b]!==
a.attributes[b]&&(c=!1,delete g.attributes[b])});return g&&(f||c)}function f(a){var b="";for(attr in a.attributes)a.attributes.hasOwnProperty(attr)&&(b+=" "+attr+'="'+a.attributes[attr]+'"');return"<"+a.tag+b+">"}function l(a){var b;for(b=h.length;b--;)if(h[b].tag===a)return b}var h,e,k,a,c,g,n,r,o,p,q=!1;definableAttributes={img:["title","src"],a:["href"]};return{init:function(){h=[{content:""}]},initTrace:function(a,b){e=[];o=void 0;g=0;n=a;r=b},finalizeTrace:function(){o&&(o=p=!1)},advancePointer:function(b){g+=
b;if(o===void 0&&g>n){b=h.length;var c;a=o=!0;for(c=1;c<b;c++)e[c-1]={tag:h[c].tag,attributes:h[c].attributes};k=e.length-1}p?o=p=!1:o&&g>r&&(p=!0)},pushTag:function(b,c){var f={tag:b,attributes:c||{},content:""};h.push(f);o&&(a?(e[k+1]={tag:f.tag,attributes:f.attributes},k+=1):e[k+1]&&(d(f)?k+=1:q=!0))},closeTag:function(b){var d;b?(d=l(b),b=h.splice(d,1)[0]):b=h.pop();o&&(a=!1,q&&(e=e.slice(0,k+1),q=!1),e[k].tag===b.tag&&(k-=1),c=!0);this.pushString(f(b)+b.content,h[d-1]);this.pushString("</"+b.tag+
">");c=!1},popLineEnd:function(){for(var a=!1,b={b:"*",i:"_"},c;"a,i,b,li".indexOf(h[h.length-1].tag)!=-1;)"li"===h[h.length-1].tag?(this.closeTag(),a=!0):(c=h.pop(),this.pushString(b[c.tag]+c.content));return a},popParagraphEnd:function(){for(;h.length>1;)this.closeTag()},pushString:function(b,d){d||(d=h[h.length-1]);d.content+=b;/^([ ]+|<br\/>)?$/.test(b)||(a&&(a=!1),o&&!c&&e[k+1]&&(e=e.slice(0,k+1)))},isOpen:function(a){return typeof l(a)==="number"},getTrace:function(){return e},toHtml:function(){return h[0].content}}}(),
n;return{compile:function(b){d.init();for(n=b;!/^\s*$/.test(n);){if(b=l(/^\s*(h\d|p|bq)(\(([^#\)]*)(#[^\)]+)?\))?\. /)){var j={};b[3]&&(j["class"]=b[3]);if(b[4])j.id=b[4];d.pushTag(b[1],j)}else d.pushTag("p");for(;!l(/^\n/)&&!/^\s*$/.test(n);){if(l(/^ *\* /))d.isOpen("ul")||d.pushTag("ul"),d.pushTag("li");else if(l(/^ *# /))d.isOpen("ol")||d.pushTag("ol"),d.pushTag("li");else for(;d.isOpen("ul")||d.isOpen("ol");)d.closeTag();match=l(/^ */);d.pushString(match[0]);for(b=b=void 0;;)if(l(/^_(?=[^ \n]+)/))d.isOpen("i")?
d.pushString("_"):d.pushTag("i");else if(l(/^\*(?=[^ \n]+)/))d.isOpen("b")?d.pushString("*"):d.pushTag("b");else if(b=l(/^([^ \n]+)_( +|(?=\n|$))/))d.isOpen("i")?(d.pushString(b[1]),d.closeTag("i"),d.pushString(b[2])):d.pushString(b[1]+"_"+b[2]);else if(b=l(/^([^ \n]+)\*( +|(?=\n|$))/))d.isOpen("b")?(d.pushString(b[1]),d.closeTag("b"),d.pushString(b[2])):d.pushString(b[1]+"*"+b[2]);else if(b=l(/^( *)"([^"]*)":([^ \n]+)/))d.pushString(b[1]),d.pushTag("a",{href:b[3]}),d.pushString(b[2]),d.closeTag();
else if(b=l(/^( *)!([^!\(]+)(\(([^\)]*)\))?!(:([^ ]+))?/)){d.pushString(b[1]);b[6]&&d.pushTag("a",{href:b[6]});j={src:b[2]};if(b[4])j.title=b[4];d.pushTag("img",j);d.closeTag();b[6]&&d.closeTag()}else if(b=l(/^([^ \n]+)/))d.pushString(b[1]);else if(b=l(/^( +)/))d.pushString(b[1]);else{l(/^\n/);b=d.popLineEnd();!b&&!/^\s*(\n|$|[\*#] )/.test(n)&&d.pushString("<br/>");break}}d.popParagraphEnd()}return d.toHtml()},trace:function(b,j,f){d.initTrace(j,f);this.compile(b);d.finalizeTrace();return d.getTrace()}}}();
ME.addMode("html",function(){return{name:"Html Mode",buttons:{"default":{clicked:function(l){var d="<"+this.delimiter+">"+l.getSelection()+"</"+this.delimiter+">";l.replaceSelection(d)}},bold:{delimiter:"b"},italic:{delimiter:"i"},alignLeft:{clicked:function(l){l.getSelection()}},alignRight:{clicked:function(){}}},selects:{formatBlock:{clicked:function(l,d){var n=l.textArea,b=n[0].selectionStart;if(b===0)return!1;var j=n.val(),f=j.slice(0,b);b=j.slice(b);j="</"+d.value+">";var m,h,e,k,a=["<p>","<h1>",
"<h2>","<h3>"];m=0;for(e=-1;m<4;m++)h=f.lastIndexOf(a[m]),h>e&&(e=h,k=a[m]);f=f.slice(0,e)+"<"+d.value+">"+f.slice(e+k.length);k=k.replace(/(\w+)/,"/$1");h=f.lastIndexOf(k);h>e?(e=h,f=f.slice(0,e)+j+f.slice(e+k.length)):(e=b.indexOf(k),b=b.slice(0,e)+j+b.slice(e+k.length));n.val(f+b)}}},toHTML:function(){return this.textArea.val()},toText:function(){return this.htmlDiv.html()}}});
ME.addMode("wysiwyg",function(){function l(b){return b.parent().is(".preview")?b:b.parentsUntil(".preview").last()}function d(){var b,d,a=-1;b=l(jQuery(m.getRangeAt(0).startContainer));d=l(jQuery(m.getRangeAt(0).endContainer))[0];return b[0]!==d?b.nextAll().filter(function(b){this==d&&(a=b);if(a===-1||a===b)return!0}).add(b):b}function n(b){d().removeClass("left").removeClass("right").removeClass("center").addClass(b)}function b(b){var d=b[0];b.length>1?(b=b[b.length-1],h.setStart(d,0),h.setEnd(b,
b.childNodes.length)):h.selectNodeContents(d);m.removeAllRanges();m.addRange(h)}var j={},f=jQuery,m=getSelection(),h=document.createRange();return{name:"Preview Mode",buttons:{"default":{clicked:function(b,d){var a=m.getRangeAt(0),c;/ on$/.test(d.className)?document.execCommand(this.name,!1,null):(c=document.createElement(this.tag),a.surroundContents(c),m.removeAllRanges(),m.addRange(a))}},bold:{tag:"b"},italic:{tag:"i"},alignLeft:{clicked:function(){n("left")}},alignRight:{clicked:function(){n("right")}},
alignCenter:{clicked:function(){n("center")}},link:{clicked:function(b,d){var a,c,g,h=m.getRangeAt(0),l={remove:function(){var a=c.text();c.replaceWith(a)},close:function(){b.htmlDiv.focus();b.editor.checkState()}};/ on$/.test(d.className)?(c=f(j.a),a=ME.dialog.link(["Update","Remove","Cancel"]),l.submit=function(a,b){c.attr("href",b).text(a);h.selectNodeContents(c[0]);m.removeAllRanges();m.addRange(h)},g=c.text(),a.val("input.uri",c.attr("href"))):(a=ME.dialog.link(["Ok","Cancel"]),l.submit=function(a,
b){var c=f('<a href="'+b+'">'+a+"</a>")[0];h.deleteContents();h.insertNode(c);h.selectNodeContents(c);m.removeAllRanges();m.addRange(h)},g=h.toString());/^\s*$/.test(g)||a.val(".title",g);a.dialog("open",l)}},insertImage:{clicked:function(b,d){var a,c,g=window.getSelection(),h=g.getRangeAt(0);/ on$/.test(d.className)?(a=ME.dialog.insertImage(["Update","Remove","Cancel"]),j.a&&(c=f(j.a),a.val("input.uri",c.attr("href")),h.selectNode(j.a)),imageNode=f(j.img),a.val("input.imageUri",imageNode.attr("src")),
a.val("input.title",imageNode.attr("title"))):a=ME.dialog.insertImage(["Ok","Cancel"]);a.dialog("open",{submit:function(a,b,c){var d=a=f('<img src="'+a+'"/>');/^\s*$/.test(b)||a.attr({alt:b,title:b});/^\s*$/.test(c)||(d=f('<a href="'+c+'"/>').append(a));h.deleteContents();h.insertNode(d[0]);h.selectNode(a[0]);g.removeAllRanges();g.addRange(h)},remove:function(){imageNode.remove()},close:function(){b.htmlDiv.focus();b.editor.checkState()}})}}},selects:{formatBlock:{clicked:function(e,h){var a,c=[];
d().replaceWith(function(){a=f("<"+h.value+"></"+h.value+">").addClass(this.className).append(this.childNodes);c.push(a[0]);return a});b(c)}}},afterActivation:function(){this.textArea.hide();this.htmlDiv.attr("contentEditable",!0);jQuery.browser.mozilla&&document.execCommand("styleWithCSS",null,!1)},getStates:function(){if(f(document.activeElement).is(".preview")){var b=jQuery(m.getRangeAt(0).startContainer),d=m.getRangeAt(0).cloneContents().firstChild;d&&d.nodeName!="#text"&&b[0].nodeName!="#text"&&
(b=b.find(d.nodeName.toLowerCase()));return this.buildStateObject(b.parentsUntil(".preview").add(b),j={})}},toText:function(){return this.editor.getDataMode().toText()},toHTML:function(){return this.textArea.val()}}});
